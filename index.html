<!DOCTYPE html>
<html>
  <head>
    <title>Magic Mirror</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- <script src="code.js"></script> -->

    <link href="main.css" rel="stylesheet" />
    <link
      href="https://fonts.googleapis.com/css?family=Oxygen:300,400,700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="up">
      <div class="date">
        <div id="hour"></div>
        <div id="date"></div>
      </div>
      <div class="wheather">
        <div class="outside">
          <div id="icon"></div>
          <div id="zone_temperature"></div>
        </div>
        <div id="city"></div>
      </div>
    </div>
    <button onclick="changePage()"></button>
    <div id="homePage">
      <div>
        <h1>Bonjour Sihem</h1>
      </div>
      <div class="events">
        <div id="agenda"></div>
        <ul id="events"></ul>
      </div>
    </div>
    <div id="audioPlayer">
      <div id="musicTitle"></div>
      <audio id="audio"></audio>
      <button id="previous" onclick="PreviousMusic()">Previous</button>
      <button id="playbutton" onclick="PlayMusic()"></button>
      <button id="next" onclick="NextMusic()">Next</button>

      <input
        id="volume"
        type="range"
        min="0"
        max="1"
        step="0.01"
        onchange="AdjustVolume()"
        display="none"
      />

      <div id="list"><ul id="musics"></ul></div>
    </div>

    <script>
      const { ipcRenderer } = require("electron");
      const os = require("os");

      function checkPlatform() {
        var nodeListButton = document.getElementsByTagName("button").length;

        if (os.platform() === "darwin") {
          for (var i = 0; i < nodeListButton; i++) {
            document.getElementsByTagName("button")[i].style.display = "block";
          }
        }
      }

      checkPlatform();
      var date = new Date();
      var days = ["Dim.", "Lun.", "Mar.", "Mer.", "Jeu.", "Ven.", "Sam."];
      var months = [
        "Janvier",
        "Fevrier",
        "Mars",
        "Avril",
        "Mai",
        "Juin",
        "Juillet",
        "Août",
        "Septembre",
        "Octobre",
        "Novembre",
        "Decembre"
      ];

      function timeFunc() {
        var date = new Date();
        var hours = date.getHours();
        if (hours < 10) {
          hours = "0" + hours;
        }
        var minutes = date.getMinutes();
        if (minutes < 10) {
          minutes = "0" + minutes;
        }
        var time = "";
        time += hours + ":" + minutes;
        var day = days[date.getDay()];
        var date = date.getDate();
        var minutes = date.getMinutes();
        var month = months[date.getMonth()];
        var year = date.getFullYear();
        var now = "";
        now += day + " " + date + " " + month + " " + year;
        document.getElementById("hour").innerHTML = time;
        document.getElementById("date").innerHTML = now;
        setTimeout(timeFunc, 60000);
      }

      timeFunc();
      wheather();

      function wheather() {
        var url =
          "https://api.openweathermap.org/data/2.5/weather?q=Paris,fr&appid=c21a75b667d6f7abb81f118dcf8d4611&units=metric";
        fetch(url).then(function(response) {
          response.json().then(callBackGetSuccess);
        });
      }

      function callBackGetSuccess(data) {
        var wheatherArray = ["Clear", "Clouds", "Rain"];

        var temperature = document.getElementById("zone_temperature");
        temperature.innerHTML = Math.floor(data.main.temp) + "°";
        var city = document.getElementById("city");
        city.innerHTML = data.name;

        var icon = document.getElementById("icon");
        weatherArray.forEach(function(className) {
          icon.classList.remove(className);
        });
        icon.classList.add(data.weather[0].main);
      }
      setTimeout(wheather, 900000);

      ipcRenderer.on("agenda-data-ready", (event, events) => {
        console.log("mesevenements :", events);
        if (events.length === 0) {
          return (document.getElementById("events").innerHTML =
            "Vous n'avez pas d'évènements de prévu aujourd'hui");
        }
        document.getElementById("events").innerHTML = events
          .map(function(evenements) {
            var dateEvents = new Date(evenements.start.dateTime);
            var minutes = dateEvents.getMinutes();
            if (minutes < 10) {
              minutes = "0" + minutes;
            }
            var hours = dateEvents.getHours();
            if (hours < 10) {
              hours = "0" + heures;
            }
            return (
              "<li>" +
              "<span class='dateEvents'>" +
              heures +
              "h" +
              minutes +
              "   " +
              "</span>" +
              "<span class='summaryEvents'>" +
              evenements.summary +
              "</span>" +
              "</li>"
            );
          })
          .join("");
      });

      function refreshAgenda() {
        ipcRenderer.send("give-me-data");
        setTimeout(refreshAgenda, 5 * 60 * 1000);
      }
      refreshAgenda();
      var list;
      var currentMusic = 0;
      ipcRenderer.on("music-data", (event, items) => {
        list = items;
        audio.src = "musics/" + items[0];
        document.getElementById("musicTitle").innerHTML = items[0];
        // audio.play();

        var incrementation = 0;
        var musicNumber = 1;
        document.getElementById("musics").innerHTML = items
          .map(function(item) {
            var path = "musics";

            return (
              "<li id='li_" +
              incrementation++ +
              "' >" +
              musicNumber++ +
              ".    " +
              item +
              "</li>"
            );
          })
          .join("");
        let itemsLi = document.querySelectorAll("#musics li");
        itemsLi.forEach(function(itemLi) {
          observer.observe(itemLi);
        });
      });

      ipcRenderer.send("wait-for-data");

      var audio = document.getElementById("audio");
      document.getElementById("playbutton").innerHTML = "play";
      var isPlaying = false;

      function PlayMusic() {
        if (show === false) {
          return;
        }
        if (isPlaying) {
          audio.pause();
          document.getElementById("audioPlayer").classList.add("pause");
        } else {
          audio.play();
          document.getElementById("audioPlayer").classList.remove("pause");
        }
      }
      audio.onplaying = function() {
        isPlaying = true;
        document.getElementById("playbutton").innerHTML = "pause";
      };
      audio.onpause = function() {
        isPlaying = false;
        document.getElementById("playbutton").innerHTML = "play";
      };

      audio.onended = NextMusic;

      let observer = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
          if (entry.intersectionRatio === 1) {
            entry.target.setAttribute("isVisible", "true");
          } else {
            entry.target.setAttribute("isVisible", "false");
          }
        });
      });

      function NextMusic() {
        document.getElementById("li_" + currentMusic).style.fontWeight =
          "normal";
        currentMusic++;
        document.getElementById("li_" + currentMusic).style.fontWeight = "bold";
        if (currentMusic === list.length) {
          currentMusic = 0;
        }
        if (
          document
            .getElementById("li_" + currentMusic)
            .getAttribute("isVisible") === "false"
        ) {
          document.getElementById("list").scrollTop += 40;
        }
        if (currentMusic === list.length - 1) {
          document.getElementById("list").scrollTop = document.getElementById(
            "list"
          ).scrollHeight;
        }
        audio.src = "musics/" + list[currentMusic];
        audio.play();

        document.getElementById("musicTitle").innerHTML = list[currentMusic];
      }

      function PreviousMusic() {
        document.getElementById("li_" + currentMusic).style.fontWeight =
          "normal";
        currentMusic--;

        if (currentMusic === -1) {
          currentMusic = list.length - 1;
        }
        document.getElementById("li_" + currentMusic).style.fontWeight = "bold";
        console.log(document.getElementById("list").scrollHeight);
        if (
          document
            .getElementById("li_" + currentMusic)
            .getAttribute("isVisible") === "false"
        ) {
          document.getElementById("list").scrollTop -= 40;
        }
        if (currentMusic === 0) {
          document.getElementById("list").scrollTop = 0;
        }
        audio.src = "musics/" + list[currentMusic];
        audio.play();
        document.getElementById("musicTitle").innerHTML = list[currentMusic];
      }
      function AdjustVolume() {
        var volume = document.getElementById("volume");
        audio.volume = volume.value;
      }

      var show = false;
      function changePage() {
        if (show) {
          document.getElementById("homePage").style.display = "block";
          document.getElementById("audioPlayer").style.display = "none";
        } else {
          document.getElementById("homePage").style.display = "none";
          document.getElementById("audioPlayer").style.display = "block";
        }
        show = !show;
      }

      var gpio = require("rpi-gpio");

      gpio.setMode(gpio.MODE_BCM);

      gpio.on("change", function(channel, value) {
        console.log(channel + " " + value);
        if (channel === 18 && value) {
          changePage();
        } else if (channel === 17 && value) {
          PlayMusic();
        } else if (channel === 27 && value) {
          NextMusic();
        } else if (channel === 22 && value) {
          PreviousMusic();
        } else if (channel === 23 && value) {
          if (audio.volume <= 0.9) {
            audio.volume += 0.1;
          }
        }
      });

      gpio.setup(18, gpio.DIR_IN, gpio.EDGE_BOTH);

      gpio.setup(17, gpio.DIR_IN, gpio.EDGE_BOTH);

      gpio.setup(27, gpio.DIR_IN, gpio.EDGE_BOTH);

      gpio.setup(22, gpio.DIR_IN, gpio.EDGE_BOTH);

      gpio.setup(23, gpio.DIR_IN, gpio.EDGE_BOTH);
    </script>
  </body>
</html>
